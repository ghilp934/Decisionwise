name: RC Gates

on:
  pull_request:
    branches:
      - master
  push:
    branches:
      - master
      - 'release/**'
  workflow_dispatch:
    inputs:
      run_windows:
        description: 'Run Windows job (default: false)'
        required: false
        type: boolean
        default: false
      retention_days:
        description: 'Artifact retention days (default: 7)'
        required: false
        type: number
        default: 7
  schedule:
    # Daily at 09:00 KST (00:00 UTC)
    - cron: '0 0 * * *'

# Minimal permissions (write for PR comments)
permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # ─────────────────────────────────────────────────────────────────────────────
  # Phase 4.2: SAST — CodeQL (Python)
  # 권한: job-level에서만 security-events: write 부여 (최소권한 원칙)
  # Fork PR에서는 skip — fork에서는 security-events: write가 제한됨
  # ─────────────────────────────────────────────────────────────────────────────
  sast_codeql:
    name: SAST — CodeQL (Python)
    runs-on: ubuntu-latest
    timeout-minutes: 30
    # Fork PR은 security-events: write 권한 없음 → skip
    if: github.event_name != 'pull_request' || github.event.pull_request.head.repo.fork == false
    permissions:
      actions: read
      contents: read
      security-events: write

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v4
        with:
          languages: python
          queries: security-and-quality

      - name: Autobuild
        uses: github/codeql-action/autobuild@v4

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v4
        with:
          category: /language:python

  # ─────────────────────────────────────────────────────────────────────────────
  # RC Gates (Linux)
  # needs: sast_codeql — SAST 실패 시 진행 불가
  # if: sast_codeql가 성공하거나 skip(fork PR)된 경우에만 실행
  # ─────────────────────────────────────────────────────────────────────────────
  rc_gates_linux:
    name: RC Gates (Linux)
    needs: [sast_codeql]
    # sast_codeql 성공 또는 skip(fork PR)이면 진행; 실패면 중단
    if: always() && (needs.sast_codeql.result == 'success' || needs.sast_codeql.result == 'skipped')
    runs-on: ubuntu-latest
    timeout-minutes: 45
    concurrency:
      group: rc-gates-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Fail if forbidden artifacts are tracked
        shell: bash
        run: |
          set -euo pipefail
          tracked="$(git ls-files | grep -E 'BLOCKER_.*\.txt|/_ops/|prod-ca-.*\.(crt|cer|pem)|supabase-ca.*\.(crt|cer|pem)' || true)"
          if [ -n "$tracked" ]; then
            echo "ERROR: Forbidden artifacts tracked in git:"
            echo "$tracked"
            exit 1
          fi
          echo "OK: no forbidden artifacts tracked."

      - name: Fail if CRLF detected (no \r allowed)
        shell: bash
        run: |
          set -euo pipefail
          # List text files containing CR (\r). -I ignores binary. -l prints filenames.
          # Exclude Windows-only scripts (*.ps1, *.bat, *.cmd) which legitimately use CRLF
          files="$(git grep -Il $'\r' -- . ':!*.ps1' ':!*.bat' ':!*.cmd' || true)"
          if [ -n "$files" ]; then
            echo "ERROR: CRLF detected in the following files:"
            echo "$files"
            exit 1
          fi

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e 'dpp/.[dev]'
          pip install opentelemetry-api opentelemetry-sdk opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-logging

      - name: Docker environment info (evidence)
        run: |
          docker --version
          docker compose version
          docker info

      - name: Build docker images for RC-5 gate
        run: |
          docker build -f dpp/Dockerfile.api -t decisionproof-api:rc5 dpp/
          docker build -f dpp/Dockerfile.worker -t decisionproof-worker:rc5 dpp/
          docker build -f dpp/Dockerfile.reaper -t decisionproof-reaper:rc5 dpp/

      # ───────────────────────────────────────────────────────────────────────
      # Phase 4.2: Trivy 이미지 취약점 스캔 + RiskScore 컷오프 게이트
      # 컷오프: RiskScore = max_cvss * 10.0 > 70.00 → FAIL (RC Gates 실행 전 중단)
      # ECR 푸시 없음 — 로컬 빌드된 이미지 스캔만 수행
      # ───────────────────────────────────────────────────────────────────────
      - name: Create security evidence directory
        run: mkdir -p dpp/evidence/01_ci/security

      - name: Trivy scan — decisionproof-api:rc5
        uses: aquasecurity/trivy-action@v0.34.0
        with:
          image-ref: decisionproof-api:rc5
          format: json
          output: dpp/evidence/01_ci/security/trivy_image_api.json
          exit-code: '0'
          vuln-type: os,library
          ignore-unfixed: false

      - name: Trivy scan — decisionproof-worker:rc5
        uses: aquasecurity/trivy-action@v0.34.0
        with:
          image-ref: decisionproof-worker:rc5
          format: json
          output: dpp/evidence/01_ci/security/trivy_image_worker.json
          exit-code: '0'
          vuln-type: os,library
          ignore-unfixed: false

      - name: Trivy scan — decisionproof-reaper:rc5
        uses: aquasecurity/trivy-action@v0.34.0
        with:
          image-ref: decisionproof-reaper:rc5
          format: json
          output: dpp/evidence/01_ci/security/trivy_image_reaper.json
          exit-code: '0'
          vuln-type: os,library
          ignore-unfixed: false

      - name: Risk gate — CVSS → RiskScore cutoff (70.00)
        shell: bash
        run: |
          set -euo pipefail
          gate_rc=0
          python dpp/tools/security/trivy_risk_gate.py \
            dpp/evidence/01_ci/security/trivy_image_api.json \
            dpp/evidence/01_ci/security/trivy_image_worker.json \
            dpp/evidence/01_ci/security/trivy_image_reaper.json \
            > dpp/evidence/01_ci/security/trivy_summary.txt 2>&1 || gate_rc=$?
          # 결과를 로그에도 출력 (아티팩트에 저장된 것과 동일)
          cat dpp/evidence/01_ci/security/trivy_summary.txt
          if [ "$gate_rc" -eq 2 ]; then
            echo "::error::SECURITY_CUTOFF_EXCEEDED — RC Gates aborted before execution. Check trivy_summary.txt in artifacts."
            exit 1
          elif [ "$gate_rc" -ne 0 ]; then
            echo "::error::trivy_risk_gate.py exited with unexpected code $gate_rc"
            exit 1
          fi

      # ───────────────────────────────────────────────────────────────────────
      # RC Gates 실행 (보안 게이트 통과 후)
      # ───────────────────────────────────────────────────────────────────────
      - name: Execute RC gates
        run: |
          chmod +x dpp/tools/run_rc_gates.sh
          bash dpp/tools/run_rc_gates.sh

      - name: Extract RC summary
        id: rc_summary
        if: always()
        run: |
          # Find latest evidence directory
          latest_dir=$(ls -1dt dpp/evidence/01_ci/* 2>/dev/null | head -1 || echo "")

          if [ -z "$latest_dir" ]; then
            echo "latest_dir=N/A" >> "$GITHUB_OUTPUT"
            echo "status=UNKNOWN" >> "$GITHUB_OUTPUT"
            echo "fail_nodeid=" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          # Search for first FAILED line in stdout/stderr
          fail_line=$(grep -hE '^FAILED ' "$latest_dir/rc_run_stdout.log" "$latest_dir/rc_run_stderr.log" 2>/dev/null | head -1 || echo "")

          # Determine status and extract nodeid
          if [ -n "$fail_line" ]; then
            status="FAIL"
            nodeid=$(echo "$fail_line" | awk '{print $2}')
          else
            status="PASS"
            nodeid=""
          fi

          # Output to GITHUB_OUTPUT
          echo "latest_dir=$latest_dir" >> "$GITHUB_OUTPUT"
          echo "status=$status" >> "$GITHUB_OUTPUT"
          echo "fail_nodeid=$nodeid" >> "$GITHUB_OUTPUT"

          # Debug output
          echo "Latest evidence: $latest_dir"
          echo "Status: $status"
          echo "First failure nodeid: $nodeid"

      - name: Find existing PR comment
        id: find_comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
        uses: peter-evans/find-comment@v3
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-author: 'github-actions[bot]'
          body-includes: '<!-- RC_GATES_SUMMARY -->'

      - name: Create or update PR comment
        if: github.event_name == 'pull_request' && github.event.pull_request.head.repo.fork == false
        uses: peter-evans/create-or-update-comment@v4
        continue-on-error: true
        with:
          issue-number: ${{ github.event.pull_request.number }}
          comment-id: ${{ steps.find_comment.outputs.comment-id }}
          edit-mode: replace
          body: |
            <!-- RC_GATES_SUMMARY -->
            ### RC Gates: ${{ steps.rc_summary.outputs.status }}

            **Latest evidence:** `${{ steps.rc_summary.outputs.latest_dir }}`

            **First failure nodeid:** ${{ steps.rc_summary.outputs.fail_nodeid || 'N/A' }}

            ---
            _Workflow run: [${{ github.run_id }}](https://github.com/${{ github.repository }}/actions/runs/${{ github.run_id }})_

      - name: Upload evidence artifact
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rc-gates-${{ github.run_id }}-${{ github.run_attempt }}
          path: dpp/evidence/01_ci/**
          retention-days: ${{ github.event.inputs.retention_days || 7 }}
          if-no-files-found: warn

  rc_gates_windows:
    name: RC Gates (Windows)
    runs-on: windows-latest
    timeout-minutes: 45
    if: github.event_name == 'workflow_dispatch' && github.event.inputs.run_windows == 'true'
    concurrency:
      group: rc-gates-windows-${{ github.ref }}
      cancel-in-progress: true

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python 3.12
        uses: actions/setup-python@v5
        with:
          python-version: '3.12'
          cache: 'pip'

      - name: Install Python dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -e 'dpp/.[dev]'
          pip install opentelemetry-api opentelemetry-sdk opentelemetry-instrumentation-fastapi opentelemetry-instrumentation-logging

      - name: Docker environment info (evidence)
        run: |
          docker --version
          docker compose version

      - name: Execute RC gates (PowerShell)
        shell: pwsh
        run: |
          powershell -ExecutionPolicy Bypass -File dpp\tools\run_rc_gates.ps1

      - name: Upload evidence artifact (Windows)
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: rc-gates-windows-${{ github.run_id }}-${{ github.run_attempt }}
          path: dpp/evidence/01_ci/**
          retention-days: ${{ github.event.inputs.retention_days || 7 }}
          if-no-files-found: warn
