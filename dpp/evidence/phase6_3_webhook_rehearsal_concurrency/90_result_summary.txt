Phase 6.3 — Result Summary & Acceptance Criteria
=================================================
Date    : 2026-02-21
Branch  : phase6-preflight
Version : DPP v0.4.2.2
Verdict : PASS — All 8 Acceptance Criteria met

=======================================================================
ACCEPTANCE CRITERIA CHECKLIST
=======================================================================

AC1: Identical webhook × 5 → exactly 1 DB commit, 4 safe ACK (200)
     Status: PASS
     Evidence: T4 test — _process_call_count=1, processed=1, already_processed=4
     Detail:
       Threading.Lock-based fake dedup store proves atomicity of gate logic.
       asyncio.gather sends 5 concurrent requests; exactly 1 returns "processed".

AC2: Atomic gate uses INSERT ON CONFLICT (not SELECT-then-INSERT)
     Status: PASS
     Evidence: webhook_dedup.py lines 113-127
     Detail:
       INSERT INTO webhook_dedup_events ... ON CONFLICT (provider, dedup_key) DO NOTHING RETURNING id
       No SELECT before INSERT — race condition eliminated.

AC3: Logs contain only payload_hash/size (no raw body content)
     Status: PASS
     Evidence: T3 test — SENTINEL_RAW_BODY_MUST_NOT_APPEAR_IN_LOGS not in any log record
     Detail:
       WEBHOOK_RECEIVED log has payload_hash and payload_size extras only.
       Log capture inspects all record attributes including nested dict/list values.

AC4: Failed events (status='failed') can be re-claimed via step 2
     Status: PASS
     Evidence: webhook_dedup.py lines 138-157 (UPDATE WHERE status='failed' RETURNING id)
     Detail:
       Step 2 allows PG retry of genuinely failed events without manual intervention.
       mark_dedup_failed() sets status='failed'; subsequent delivery re-claims.

AC5: Migration SQL creates UNIQUE(provider, dedup_key) constraint
     Status: PASS
     Evidence: 20260221_create_webhook_dedup_events_p6_3.sql line 43-45
     Detail:
       ALTER TABLE webhook_dedup_events
           ADD CONSTRAINT uq_webhook_dedup_events
           UNIQUE (provider, dedup_key);
       Partial index on status IN ('processing', 'failed') for efficient lookup.

AC6: WebhookDedupEvent ORM model consistent with migration schema
     Status: PASS
     Evidence: db/models.py — WebhookDedupEvent class
     Detail:
       Table: webhook_dedup_events
       Columns: id (BIGINT PK), provider, dedup_key, first_seen_at,
                last_seen_at, status CHECK(processing|done|failed), request_hash
       Constraint: UniqueConstraint("provider", "dedup_key", name="uq_webhook_dedup_events")
       Indexes match migration SQL (provider_key, status partial, first_seen)

AC7: T1-T4 tests pass (4/4, no real DB/network)
     Status: PASS
     Evidence: 30_pytest.txt
     Detail:
       T1 PASS — 0.xx s — dedup conflict → 200 already_processed; no business call
       T2 PASS — 0.xx s — dedup success → business processing called once
       T3 PASS — 0.xx s — log hygiene: SENTINEL not in any log record
       T4 PASS — 0.xx s — 5 concurrent → exactly 1 process call
       Total: 4/4 PASSED in 0.96s (no PostgreSQL, no PayPal/Toss calls)

AC8: Runbook + concurrency bomb script executable by operator
     Status: PASS
     Evidence: ops/runbooks/webhook_rehearsal_concurrency.md + ops/scripts/p6_3_webhook_concurrency_bomb.py
     Detail:
       Runbook: 5-step procedure (DB check, input prep, bomb run, DB verify, log verify)
       Bomb script: asyncio.gather × N, payload_hash/size output only, PASS/FAIL verdict

=======================================================================
CHANGED FILES SUMMARY
=======================================================================

NEW:
  dpp/apps/api/dpp_api/billing/webhook_dedup.py
  dpp/migrations/20260221_create_webhook_dedup_events_p6_3.sql
  dpp/apps/api/tests/test_phase6_3_webhook_idempotency_gate.py
  dpp/ops/scripts/p6_3_webhook_concurrency_bomb.py
  dpp/ops/scripts/.local/webhook_payload.sample.json
  dpp/ops/scripts/.local/webhook_headers.sample.json
  dpp/ops/runbooks/webhook_rehearsal_concurrency.md
  dpp/evidence/phase6_3_webhook_rehearsal_concurrency/ (this folder)

MODIFIED:
  dpp/apps/api/dpp_api/db/models.py
    → WebhookDedupEvent ORM model added
  dpp/apps/api/dpp_api/routers/webhooks.py
    → PayPal Step 6: atomic dedup gate replaces SELECT-then-INSERT
    → Toss Step 4: atomic dedup gate replaces SELECT-then-INSERT
    → New imports: webhook_dedup, sanitize, payload_hash_bytes
  dpp/.gitignore
    → ops/scripts/.local/ added (P6.3 credential files gitignored)

=======================================================================
NON-NEGOTIABLES VERIFIED
=======================================================================

[x] PayPal handler: try_acquire_dedup() called before business processing
[x] Toss handler: try_acquire_dedup() called before Toss API re-query
[x] Atomic INSERT ON CONFLICT DO NOTHING — no SELECT-then-INSERT
[x] mark_dedup_done() called on business processing success
[x] mark_dedup_failed() called on exception (in except block)
[x] db.close() in finally block — no connection leak
[x] 200 returned for all duplicates (never 4xx/5xx for retries)
[x] WEBHOOK_ALREADY_PROCESSED logged with provider + payload_hash (no raw body)
[x] Dedup key deterministic: ev_{event.id} (PayPal) / tx_{tid} (Toss)
[x] Fallback dedup key when primary missing (header → paymentKey)
[x] PG retry allowed: status='failed' reclaimed by step 2
[x] Migration has UNIQUE constraint (not just application-level check)
[x] .local/ gitignored (real credentials never committed)
[x] Sample files have PLACEHOLDER values only

=======================================================================
REMAINING TODO (next phases)
=======================================================================

- [ ] Phase 6.4: Cutover runbook + WORM evidence tar.gz + sha256 + S3 upload
- [ ] Production: Apply migration SQL to production DB before deployment
- [ ] Production: Run concurrency bomb against staging environment
- [ ] Production: Confirm WEBHOOK_DEDUP_ACQUIRED appears in prod logs

=======================================================================
PHASE 6.3: COMPLETE
Next: Phase 6.4 (Cutover runbook + WORM evidence tar.gz)
=======================================================================
