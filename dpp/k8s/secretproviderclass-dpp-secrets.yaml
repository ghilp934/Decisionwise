# DEC-P04-SECRETS: AWS Secrets Manager → ASCP → Pod 동적 주입
# SecretProviderClass — dpp-production namespace
#
# 전제조건 (배포 전 반드시 충족):
#   1. Secrets Store CSI Driver 설치 완료
#      helm repo add secrets-store-csi-driver https://kubernetes-sigs.github.io/secrets-store-csi-driver/charts
#      helm install csi-secrets-store secrets-store-csi-driver/secrets-store-csi-driver \
#        --namespace kube-system --set syncSecret.enabled=true
#
#   2. AWS Provider 설치 완료
#      kubectl apply -f https://raw.githubusercontent.com/aws/secrets-store-csi-driver-provider-aws/main/deployment/aws-provider-installer.yaml
#
#   3. AWS Secrets Manager에 JSON Secret 생성 완료
#      Secret Name: decisionproof/prod/dpp-secrets
#      JSON 필수 키: database-url, redis-url, redis-password,
#                   sentry-dsn, supabase-url, sb-publishable-key, sb-secret-key
#      (값 예시는 ops/runbooks/secrets_ascp_irsa.md 참조)
#
#   4. IRSA 역할에 secretsmanager:GetSecretValue 권한 부여 완료
#      대상 역할: dpp-api-role, dpp-worker-role, dpp-reaper-role,
#               decisionproof-ses-feedback-sa (연결된 IRSA 역할)
#      정책 파일: infra/policies/irsa_minimal_secretsmanager_read.json
#
# ⚠️ SYNC 주의:
#   secretObjects(Kubernetes Secret sync)는 Pod가 이 SecretProviderClass를
#   참조하는 secrets-store CSI 볼륨을 실제로 마운트해야 동작합니다.
#   Pod 없이 kubectl apply만으로는 dpp-secrets Secret이 생성되지 않습니다.
#
# ⚠️ Pilot 네임스페이스 사용 시:
#   dpp-pilot 네임스페이스에도 동일 스펙으로 별도 apply 필요.
#   metadata.namespace를 dpp-pilot으로 변경하여 적용하십시오.
#   (ops/runbooks/secrets_ascp_irsa.md 참조)

apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: dpp-secrets-aws
  namespace: dpp-production
spec:
  provider: aws
  parameters:
    objects: |
      - objectName: "decisionproof/prod/dpp-secrets"
        objectType: "secretsmanager"
        jmesPath:
          - path: "database-url"
            objectAlias: "database-url"
          - path: "redis-url"
            objectAlias: "redis-url"
          - path: "redis-password"
            objectAlias: "redis-password"
          - path: "sentry-dsn"
            objectAlias: "sentry-dsn"
          - path: "supabase-url"
            objectAlias: "supabase-url"
          - path: "sb-publishable-key"
            objectAlias: "sb-publishable-key"
          - path: "sb-secret-key"
            objectAlias: "sb-secret-key"
  # secretObjects: Pod가 volumes에 이 SecretProviderClass를 마운트하면
  # 아래 Kubernetes Secret(dpp-secrets)이 자동 생성/갱신됩니다.
  # 기존 Deployment의 secretKeyRef(name=dpp-secrets)는 변경 없이 유지됩니다.
  secretObjects:
    - secretName: dpp-secrets
      type: Opaque
      data:
        - key: database-url
          objectName: database-url
        - key: redis-url
          objectName: redis-url
        - key: redis-password
          objectName: redis-password
        - key: sentry-dsn
          objectName: sentry-dsn
        - key: supabase-url
          objectName: supabase-url
        - key: sb-publishable-key
          objectName: sb-publishable-key
        - key: sb-secret-key
          objectName: sb-secret-key
