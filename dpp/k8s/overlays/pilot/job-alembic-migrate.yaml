# job-alembic-migrate.yaml
# Alembic DB 마이그레이션 Job 템플릿
#
# 사용법 (Deploy 1단계):
#   kubectl apply -n dpp-pilot -f job-alembic-migrate.yaml
#   kubectl wait -n dpp-pilot --for=condition=complete --timeout=600s job/alembic-migrate
#
# 전제조건:
#   - dpp-pilot 네임스페이스에 dpp-supabase-ca ConfigMap이 사전 생성되어 있어야 합니다.
#     kubectl create configmap dpp-supabase-ca \
#       --from-file=supabase-ca.crt=/path/to/supabase-ca.crt \
#       -n dpp-pilot
#   - SecretProviderClass(dpp-secrets-aws)가 dpp-pilot 네임스페이스에 존재해야 합니다.
#     (kubectl apply -k dpp/k8s/overlays/pilot 실행 후 가능)
#   - IRSA 역할(dpp-api-role)에 secretsmanager:GetSecretValue 권한 필요
apiVersion: v1
kind: ServiceAccount
metadata:
  name: dpp-migrator
  namespace: dpp-pilot
  annotations:
    eks.amazonaws.com/role-arn: arn:aws:iam::783268398937:role/dpp-api-role

---
apiVersion: batch/v1
kind: Job
metadata:
  name: alembic-migrate
  namespace: dpp-pilot
  labels:
    app: dpp
    component: migrate
spec:
  backoffLimit: 1
  ttlSecondsAfterFinished: 600
  activeDeadlineSeconds: 600
  template:
    metadata:
      labels:
        app: dpp
        component: migrate
    spec:
      serviceAccountName: dpp-migrator
      restartPolicy: Never
      containers:
      - name: alembic-migrate
        image: 783268398937.dkr.ecr.ap-northeast-2.amazonaws.com/dpp-api:0.4.2.2
        command: ["/bin/sh", "-c"]
        args:
          - |
            set -euo pipefail
            export DATABASE_URL="$(cat /mnt/secrets-store/database-url)"
            export DPP_DB_SSLROOTCERT="/etc/ssl/certs/supabase-ca/supabase-ca.crt"
            python -m alembic upgrade head
        volumeMounts:
          - name: secrets-store-inline
            mountPath: /mnt/secrets-store
            readOnly: true
          - name: supabase-ca
            mountPath: /etc/ssl/certs/supabase-ca
            readOnly: true
      volumes:
        - name: secrets-store-inline
          csi:
            driver: secrets-store.csi.k8s.io
            readOnly: true
            volumeAttributes:
              secretProviderClass: dpp-secrets-aws
        - name: supabase-ca
          configMap:
            name: dpp-supabase-ca
