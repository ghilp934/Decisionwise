# secretproviderclass-dpp-secrets-pilot.yaml
# Pilot 전용 SecretProviderClass
# objectName: "decisionproof/pilot/dpp-secrets" (prod: decisionproof/prod/dpp-secrets)
#
# ⚠️ SYNC 주의:
#   secretObjects(Kubernetes Secret sync)는 Pod가 이 SecretProviderClass를
#   참조하는 secrets-store CSI 볼륨을 실제로 마운트해야 동작합니다.
#   Pod 없이 kubectl apply만으로는 dpp-secrets Secret이 생성되지 않습니다.
#
# 전제조건:
#   1. Secrets Store CSI Driver 설치 완료 (kube-system)
#   2. AWS Provider 설치 완료
#   3. AWS Secrets Manager에 decisionproof/pilot/dpp-secrets JSON secret 생성 완료
#   4. IRSA 역할(dpp-api-role, dpp-worker-role, dpp-reaper-role)에
#      secretsmanager:GetSecretValue 권한 부여 완료
apiVersion: secrets-store.csi.x-k8s.io/v1
kind: SecretProviderClass
metadata:
  name: dpp-secrets-aws
spec:
  provider: aws
  parameters:
    objects: |
      - objectName: "decisionproof/pilot/dpp-secrets"
        objectType: "secretsmanager"
        jmesPath:
          - path: '"database-url"'
            objectAlias: "database-url"
          - path: '"redis-url"'
            objectAlias: "redis-url"
          - path: '"redis-password"'
            objectAlias: "redis-password"
          - path: '"sentry-dsn"'
            objectAlias: "sentry-dsn"
          - path: '"supabase-url"'
            objectAlias: "supabase-url"
          - path: '"sb-publishable-key"'
            objectAlias: "sb-publishable-key"
          - path: '"sb-secret-key"'
            objectAlias: "sb-secret-key"
          - path: "paypal_client_id"
            objectAlias: "paypal-client-id"
          - path: "paypal_client_secret"
            objectAlias: "paypal-client-secret"
          - path: "paypal_webhook_id"
            objectAlias: "paypal-webhook-id"
          - path: "toss_secret_key"
            objectAlias: "toss-secret-key"
          - path: "toss_webhook_secret"
            objectAlias: "toss-webhook-secret"
          - path: "ks_audit_fingerprint_pepper_b64"
            objectAlias: "ks-audit-fingerprint-pepper-b64"
  secretObjects:
    - secretName: dpp-secrets
      type: Opaque
      data:
        - key: database-url
          objectName: database-url
        - key: redis-url
          objectName: redis-url
        - key: redis-password
          objectName: redis-password
        - key: sentry-dsn
          objectName: sentry-dsn
        - key: supabase-url
          objectName: supabase-url
        - key: sb-publishable-key
          objectName: sb-publishable-key
        - key: sb-secret-key
          objectName: sb-secret-key
        - key: paypal-client-id
          objectName: paypal-client-id
        - key: paypal-client-secret
          objectName: paypal-client-secret
        - key: paypal-webhook-id
          objectName: paypal-webhook-id
        - key: toss-secret-key
          objectName: toss-secret-key
        - key: toss-webhook-secret
          objectName: toss-webhook-secret
        - key: ks-audit-fingerprint-pepper-b64
          objectName: ks-audit-fingerprint-pepper-b64
