# Decisionproof API Platform — Release Notes

**Tag**: v0.4.2.2-pilot.2  
**Type**: Prerelease (Pilot)  
**Environment**: dpp-pilot (EKS, ap-northeast-2)  
**Date**: 2026-02-21

---

## Commit & Image Digests (SSOT)

| Item | Value |
|------|-------|
| Git SHA | fb02f4865468a3ebd4e89fd2c16f3d52059630e2 |
| dpp-api digest | sha256:c3cdeefc26497c6f5b93e9e26e666083764c4bd8d6fe097dd1f5c71efe2bdd75 |
| dpp-worker digest | sha256:12cc60dd636a25f66876359cf0055cfc358d70e633125ee983b1e2f7ab48c40d |
| dpp-reaper digest | sha256:ecd3f17d398480269416f4cb3a26a74821bac98959205a3b9a29eb59c2c48701 |

---

## What's Changed

### LOCK-3: Apply Redis Cluster hash tags (prevent cross-slot)

- **Issue**: In ElastiCache Valkey Serverless (Cluster mode), the Lua `EVALSHA` script referenced keys in different cluster slots, causing a `CROSSSLOT` error.
- **Fix**: Added the `{tenant_id}` hash tag to three key constructors to force placement into the same slot:
  - `budget:{tenant_id}:balance_usd_micros`
  - `reserve:{tenant_id}:{run_id}`
  - `settle_receipt:{tenant_id}:{run_id}`
- **Affected area**: `redis_scripts.py`, `manager.py`, `reconcile_loop.py`, `audit_reconciliation.py`, and 7 test files
- **Backward compatibility**: Legacy-format keys (`budget:tenant_xxx:...`, `reserve:{run_id}`) may remain in Redis until TTL (3600s) expires or they are manually cleaned up (pilot impact is limited).
- **Breaking changes**: None — no API contract changes; only internal Redis key structure changed.

### LOCK-2: Pilot-only isolation for Billing preflight

- To allow the app to start in the Pilot environment without PayPal/Toss credentials installed, set `DPP_BILLING_PREFLIGHT_REQUIRED=0`.
- `/readyz` response: `billing_secrets: skipped` (non-blocking)
- **Isolation guarantee**: Applied only in `k8s/overlays/pilot/patch-api-deployment-pilot.yaml`; confirmed that production / production-ack1 renders keep the value as `"1"`.

### LOCK-4: Restore procps(pgrep) + probe consistency

- `Dockerfile.worker` / `Dockerfile.reaper`: added the `procps` package
  (`python:3.12-slim` does not include it → fixes the “pgrep not available” issue)
- `startupProbe`: `period=5s × failureThreshold=30` = up to 150s allowed for startup
- `livenessProbe`: based on `pgrep -f 'python.*dpp_{worker,reaper}.main'`
- `readinessProbe`: based on `/tmp/{worker,reaper}-ready` file
- Effect: prevents premature probe-triggered termination (false positives) and improves startup stability

---

## Pilot Final Operations Lockdown — Check Results (0–6)

| Check | Item | Result |
|-------|------|--------|
| 0 | EKS context/namespace guard | ✅ PASS |
| 1 | Worker/Reaper E2E processing proof | ✅ PASS |
| 2 | Probe events (restartCount=0) | ✅ PASS |
| 3 | HTTPS external connectivity smoke test | ✅ PASS |
| 4 | ALB Target Health + Listener | ✅ PASS |
| 5 | No Redis AUTH errors | ✅ PASS |
| 6 | Node/Pod CPU & memory headroom | ✅ PASS |

**Evidence (Check 1)**: run_id `be483b75-ded1-4099-9118-c66c5a76e306` → COMPLETED (~1.3s)  
**Evidence (Check 3)**: `curl https://api-pilot.decisionproof.io.kr/readyz` → HTTP 200

---

## Known Limitations (Pilot)

- Billing preflight is skipped (PayPal/Toss credentials not installed) — must be configured before production.
- Legacy-format Redis keys are awaiting TTL expiration (pilot tenants only).

---

*Generated by: Release Lockdown Automation v0.4.2.2-pilot.2*
