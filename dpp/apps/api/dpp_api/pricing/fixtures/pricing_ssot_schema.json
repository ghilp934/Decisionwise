{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "title": "Decisionproof Pricing SSoT Schema v0.2.1",
  "description": "JSON Schema for Decisionproof Pricing Single Source of Truth",
  "type": "object",
  "required": [
    "pricing_version",
    "effective_from",
    "currency",
    "unlimited_semantics",
    "meter",
    "grace_overage",
    "http",
    "tiers",
    "billing_rules"
  ],
  "properties": {
    "pricing_version": {
      "type": "string",
      "pattern": "^\\d{4}-\\d{2}-\\d{2}\\.v\\d+\\.\\d+\\.\\d+$"
    },
    "effective_from": {
      "type": "string",
      "format": "date-time"
    },
    "effective_to": {
      "oneOf": [
        {
          "type": "string",
          "format": "date-time"
        },
        {
          "type": "null"
        }
      ]
    },
    "currency": {
      "type": "object",
      "required": [
        "code",
        "symbol",
        "tax_behavior"
      ],
      "properties": {
        "code": {
          "type": "string",
          "minLength": 3,
          "maxLength": 3
        },
        "symbol": {
          "type": "string"
        },
        "tax_behavior": {
          "type": "string",
          "enum": [
            "exclusive",
            "inclusive"
          ]
        }
      }
    },
    "unlimited_semantics": {
      "type": "object",
      "required": [
        "zero_means",
        "applies_to_fields"
      ],
      "properties": {
        "zero_means": {
          "type": "string",
          "enum": [
            "custom_or_unlimited",
            "disabled"
          ]
        },
        "applies_to_fields": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "meter": {
      "type": "object",
      "required": [
        "event_name",
        "quantity_field",
        "idempotency_key_field",
        "aggregation",
        "timestamp_source",
        "idempotency_scope",
        "idempotency_retention_days"
      ],
      "properties": {
        "event_name": {
          "type": "string"
        },
        "quantity_field": {
          "type": "string"
        },
        "idempotency_key_field": {
          "type": "string"
        },
        "aggregation": {
          "type": "string",
          "enum": [
            "sum",
            "count",
            "max"
          ]
        },
        "timestamp_source": {
          "type": "string"
        },
        "idempotency_scope": {
          "type": "string"
        },
        "idempotency_retention_days": {
          "type": "integer",
          "minimum": 1
        }
      }
    },
    "grace_overage": {
      "type": "object",
      "required": [
        "enabled",
        "policy",
        "resolution",
        "max_grace_percent",
        "max_grace_dc",
        "applies_to"
      ],
      "properties": {
        "enabled": {
          "type": "boolean"
        },
        "policy": {
          "type": "string",
          "enum": [
            "waive_excess",
            "notify_only"
          ]
        },
        "resolution": {
          "type": "string",
          "enum": [
            "min_of_percent_or_dc",
            "percent_only",
            "dc_only"
          ]
        },
        "max_grace_percent": {
          "type": "number",
          "minimum": 0
        },
        "max_grace_dc": {
          "type": "integer",
          "minimum": 0
        },
        "applies_to": {
          "type": "array",
          "items": {
            "type": "string"
          }
        }
      }
    },
    "http": {
      "type": "object",
      "required": [
        "problem_details",
        "ratelimit_headers"
      ],
      "properties": {
        "problem_details": {
          "type": "object",
          "required": [
            "rfc",
            "content_type",
            "type_uris",
            "extensions"
          ],
          "properties": {
            "rfc": {
              "type": "string"
            },
            "content_type": {
              "type": "string"
            },
            "type_uris": {
              "type": "object",
              "additionalProperties": {
                "type": "string",
                "format": "uri"
              }
            },
            "extensions": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            }
          }
        },
        "ratelimit_headers": {
          "type": "object",
          "required": [
            "enabled",
            "policy_header",
            "limit_header",
            "retry_after_precedence",
            "policy_name_conventions",
            "rate_limit_window_seconds_default"
          ],
          "properties": {
            "enabled": {
              "type": "boolean"
            },
            "policy_header": {
              "type": "string"
            },
            "limit_header": {
              "type": "string"
            },
            "retry_after_precedence": {
              "type": "boolean"
            },
            "policy_name_conventions": {
              "type": "object",
              "additionalProperties": {
                "type": "string"
              }
            },
            "rate_limit_window_seconds_default": {
              "type": "integer",
              "minimum": 1
            }
          }
        }
      }
    },
    "tiers": {
      "type": "array",
      "minItems": 1,
      "items": {
        "type": "object",
        "required": [
          "tier",
          "monthly_base_price",
          "included_dc_per_month",
          "overage_price_per_dc",
          "features",
          "limits",
          "policies",
          "safety"
        ],
        "properties": {
          "tier": {
            "type": "string",
            "enum": [
              "SANDBOX",
              "STARTER",
              "GROWTH",
              "ENTERPRISE"
            ]
          },
          "monthly_base_price": {
            "type": "integer",
            "minimum": 0
          },
          "included_dc_per_month": {
            "type": "integer",
            "minimum": 0
          },
          "overage_price_per_dc": {
            "type": "integer",
            "minimum": 0
          },
          "features": {
            "type": "object",
            "additionalProperties": {
              "type": "boolean"
            }
          },
          "limits": {
            "type": "object",
            "required": [
              "rate_limit_rpm",
              "rate_limit_window_seconds",
              "monthly_quota_dc",
              "hard_overage_dc_cap",
              "overage_behavior",
              "max_execution_seconds",
              "max_input_tokens",
              "max_output_tokens"
            ],
            "properties": {
              "rate_limit_rpm": {
                "type": "integer",
                "minimum": 0
              },
              "rate_limit_window_seconds": {
                "type": "integer",
                "minimum": 1
              },
              "monthly_quota_dc": {
                "type": "integer",
                "minimum": 0
              },
              "hard_overage_dc_cap": {
                "type": "integer",
                "minimum": 0
              },
              "overage_behavior": {
                "type": "string",
                "enum": [
                  "block_on_breach",
                  "notify_only"
                ]
              },
              "max_execution_seconds": {
                "type": "integer",
                "minimum": 1
              },
              "max_input_tokens": {
                "type": "integer",
                "minimum": 1
              },
              "max_output_tokens": {
                "type": "integer",
                "minimum": 1
              }
            }
          },
          "policies": {
            "type": "object",
            "required": [
              "rpm_policy_name",
              "monthly_dc_policy_name",
              "hard_overage_cap_policy_name"
            ],
            "properties": {
              "rpm_policy_name": {
                "type": "string"
              },
              "monthly_dc_policy_name": {
                "type": "string"
              },
              "hard_overage_cap_policy_name": {
                "type": "string"
              }
            }
          },
          "safety": {
            "type": "object",
            "required": [
              "overage_alerts",
              "hard_spending_limit"
            ],
            "properties": {
              "overage_alerts": {
                "type": "boolean"
              },
              "hard_spending_limit": {
                "type": "boolean"
              }
            }
          }
        }
      }
    },
    "billing_rules": {
      "type": "object",
      "required": [
        "rounding",
        "billable",
        "non_billable",
        "limit_exceeded_http_status",
        "limit_exceeded_problem"
      ],
      "properties": {
        "rounding": {
          "type": "string"
        },
        "billable": {
          "type": "object",
          "additionalProperties": {
            "type": "boolean"
          }
        },
        "non_billable": {
          "type": "object",
          "additionalProperties": {
            "type": "boolean"
          }
        },
        "limit_exceeded_http_status": {
          "type": "integer",
          "minimum": 400,
          "maximum": 599
        },
        "limit_exceeded_problem": {
          "type": "object",
          "required": [
            "type",
            "title",
            "violated_policies_field"
          ],
          "properties": {
            "type": {
              "type": "string",
              "format": "uri"
            },
            "title": {
              "type": "string"
            },
            "violated_policies_field": {
              "type": "string"
            }
          }
        },
        "payment_required_http_status_optional": {
          "type": "integer",
          "minimum": 400,
          "maximum": 599
        }
      }
    }
  }
}